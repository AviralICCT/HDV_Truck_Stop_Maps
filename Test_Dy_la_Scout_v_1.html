<!DOCTYPE html>
<html>
<head>
    <title>Substations and H3 Cells Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Chroma.js for color scales -->
    <script src="https://cdn.jsdelivr.net/npm/chroma-js@2.1.0/chroma.min.js"></script>

    <style>
        #map {
  height: 99vh;
  width: 100%;
  position: relative;
  z-index: 0;
}
.leaflet-container { font-size: 1rem; }
		/* Top-left logo */
    		.top-left-logo {
        	position: absolute;
        	top: 10px;
        	left: 80px;
        	z-index: 1001; /* Ensure it appears above the map */
    		}

    		/* Top-right logo */
    		.top-right-logo {
        	position: absolute;
        	top: 10px;
        	right: 10px;
        	z-index: 1001; /* Ensure it appears above the map */
    }
.custom-tile {
    position: absolute;
    top: 1%;
    right: 25%;
    width: 700px;
    background-color: rgba(255, 255, 255, 0.9); /* translucent white */
    color: black ; /* text color */
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1001;
    font-size: 17px;
  }

    /* Styling for the images (optional: adjust size and appearance) */
    .top-left-logo img {
        width: 250px; /* Adjust as needed */
        height: auto;
    }
    .top-right-logo img {
        width: 100px; /* Adjust as needed */
        height: auto;
    }
        .legend {
            background: white;
            padding: 6px 8px;
            font: 14px Arial, sans-serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 18px;
            color: #555;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 6px;
        }
        .legend-color-box {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid #999;
            vertical-align: middle;
        }
.leaflet-control.legend {
  max-height: 200px;
  overflow-y: auto;
  box-sizing: border-box;
  padding: 10px;
  background: white;
  border-radius: 5px;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  font-size: 14px;
  line-height: 18px;
  color: #555;
}

  /* Move LayerControl and legend to the middle-right */
   .leaflet-top.leaflet-right {
    top: 50% !important;
    right: 1px !important;
    transform: translateY(-50%);
    z-index: 1001;
  }

  /* Move bottom-left controls (e.g., custom dropdown or legend) */
  .leaflet-bottom.leaflet-left {
    top: 34% !important;
    bottom: auto !important;
    left: auto !important;
    right: 10px !important;
    transform: translateY(-50%);
    z-index: 1001;
  }

  /* Reduce vertical space between any control blocks */
  .leaflet-control {
    margin-bottom: 4px !important;
  }
    </style>
</head>

<body>

<!-- Custom Tile Element -->
<div id="custom-tile" class="leaflet-control custom-tile">
  <h4 style="margin: 0;">SCOUT CHARGE-PARK: Scouting Tool for assessing optimal Truck Chargepark Locations</h4>

</div>

<!-- Top-left logo -->
    	<div class="top-left-logo">
         	<img src="https://coezet.iitm.ac.in/wp-content/uploads/2023/01/coezet_34-8.png" alt="Top-left Logo">
        </div>

    	<!-- Top-right logo -->
    	<div class="top-right-logo">
        	<img src="https://s12982.pcdn.co/wp-content/uploads/2019/02/icct-logo.png" alt="Top-right Logo">
    	</div>
  

<div id="map"></div>



<script>
    // Initialize map (center and zoom can be adjusted)
    const map_a4cf6b5b97eb1ca32a76d93c4fb3d669 = L.map('map').setView([20.59, 78.96], 10);

    // Add OpenStreetMap base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);
// Create a custom control for legend + dropdown
const legendControl = L.control({ position: 'bottomleft' });

legendControl.onAdd = function (map) {
  const div = L.DomUtil.create('div', 'legend');

  // Add dropdown HTML inside the control
  div.innerHTML = `
    <label for="h3Selector" style="display:block; font-weight: bold; margin-bottom: 6px;">Select Analysis Scope:</label>
    <select id="h3Selector" style="width: 100%; margin-bottom: 10px;">
      <option value="h3_cells_5_100_50.geojson">Country Level</option>
      <option value="h3_cells_7_100_50.geojson">Region/State Level</option>
      <option value="h3_cells_9_95_20.geojson">City Level</option>
    </select>

     <div>
     <div><span style="background:#ffffb2;" class="legend-color-box"></span> Lower utility</div>
     <div><span style="background:#bd0026;" class="legend-color-box"></span> Higher utility</div>
      </div>
  `;

  // Prevent map panning when interacting with the control
  L.DomEvent.disableClickPropagation(div);
  return div;
};

legendControl.addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);


    // ============================
    // Substations Layer Setup
    // ============================

    const lowVoltageLayer = L.layerGroup();
    const mediumVoltageLayer = L.layerGroup();
    const highVoltageLayer = L.layerGroup();
    const noVoltageLayer = L.layerGroup();

    // Voltage categorization function
    function categorizeVoltage(voltage) {
        if (!voltage) return 'noVoltage';

        let voltages = voltage.includes(';') ? voltage.split(';') :
                       voltage.includes(',') ? voltage.split(',') :
                       [voltage];

        let maxVoltage = 0;
        voltages.forEach(v => {
            let num = parseInt(v.replace(/D/g, ''), 10);
            if (!isNaN(num) && num > maxVoltage) maxVoltage = num;
        });

        if (maxVoltage === 0) return 'noVoltage';
        if (maxVoltage < 50000) return 'lowVoltage';
        if (maxVoltage < 132000) return 'mediumVoltage';
        return 'highVoltage';
    }

    const categoryColors = {
        lowVoltage: "#2ca02c",    // green
        mediumVoltage: "#ff7f0e", // orange
        highVoltage: "#d62728",   // red
        noVoltage: "#7f7f7f"      // gray
    };

    function makeLabelWithColor(color, label) {
        return `<span style="
            display:inline-block; 
            width:18px; 
            height:18px; 
            background:${color}; 
            margin-right:8px; 
            border-radius:3px; 
            border:1px solid #999;
            vertical-align: middle;
        "></span>${label}`;
    }

    fetch('http://localhost:8080/Downloads/Layer2sub.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    const voltageTag = feature.properties?.voltage;
                    const category = categorizeVoltage(voltageTag);

                    return L.circleMarker(latlng, {
                        radius: 6,
                        color: "#ffffff",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.9,
                        fillColor: categoryColors[category]
                    });
                },
                onEachFeature: function(feature, layer) {
                    const tags = feature.properties || {};
                    let popupContent = "<strong>Tags:</strong><ul>";
                    for (const key in tags) {
                        popupContent += `<li><b>${key}:</b> ${tags[key]}</li>`;
                    }
                    popupContent += "</ul>";

                    // Show center coordinates if present in properties
                   let coords = null;
                    if (feature.geometry.type === "Point") {
                        coords = feature.geometry.coordinates;
                    } else if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
                        try {
                            const center = turf.center(feature);
                            coords = center.geometry.coordinates;
                        } catch (e) {
                            console.warn("Could not compute center for feature", e);
                        }
                    }

                    if (coords) {
                        popupContent += `<br><strong>Center:</strong> ${coords[1]?.toFixed(6)}, ${coords[0]?.toFixed(6)}`;
                    }

                    layer.bindPopup(popupContent);

                    // Add to appropriate voltage layer
                    const category = categorizeVoltage(tags.voltage);
                    switch (category) {
                        case 'lowVoltage':
                            lowVoltageLayer.addLayer(layer);
                            break;
                        case 'mediumVoltage':
                            mediumVoltageLayer.addLayer(layer);
                            break;
                        case 'highVoltage':
                            highVoltageLayer.addLayer(layer);
                            break;
                        default:
                            noVoltageLayer.addLayer(layer);
                    }
                }
            });

            // Add all voltage layers to map by default
            lowVoltageLayer.addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);
            mediumVoltageLayer.addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);
            highVoltageLayer.addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);
            noVoltageLayer.addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);

            // Add toggle control for substations
            layerControl.addOverlay(lowVoltageLayer, makeLabelWithColor(categoryColors.lowVoltage, "Substation (<50kV)"));
            layerControl.addOverlay(mediumVoltageLayer, makeLabelWithColor(categoryColors.mediumVoltage, "Substation (50kV-132kV)"));
            layerControl.addOverlay(highVoltageLayer, makeLabelWithColor(categoryColors.highVoltage, "Substation (>132kV)"));
            layerControl.addOverlay(noVoltageLayer, makeLabelWithColor(categoryColors.noVoltage, "Substation (No Voltage Data)"));
        })
        .catch(err => console.error('Error loading Substations.geojson:', err));

    // ============================
    // H3 Cells Layer Setup
    // ============================

    let h3Layer = L.layerGroup().addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);


    // Helper: compute polygon center (average of first ring points)
    function getPolygonCenter(coords) {
        let latSum = 0, lngSum = 0, count = 0;
        coords[0].forEach(pt => {
            lngSum += pt[0];
            latSum += pt[1];
            count++;
        });
        return [latSum / count, lngSum / count];
    }

    // We will create the layer control here to add overlays later
    const layerControl = L.control.layers(null, null, {collapsed: false}).addTo(map_a4cf6b5b97eb1ca32a76d93c4fb3d669);
layerControl.addOverlay(h3Layer, "Truck Stop Data");

    // Helper functions
    function log1p(x) {
        return Math.log(1 + x);
    }

    function normalize(value, min, max) {
        return (value - min) / (max - min);
    }

async function loadH3GeoJSON(url) {
    // Remove existing layer
    h3Layer.clearLayers();

    try {
        const response = await fetch(url);
        const data = await response.json();
            // Extract duration_sum values for color scale
            const logValues = data.features
                .map(f => f.properties.duration_sum)
                .filter(v => v !== undefined && v > 0)
                .map(v => log1p(v));

            const minLog1p = Math.min(...logValues);
            const maxLog1p = Math.max(...logValues);

            // Create chroma color scale with YlOrRd palette
            const colorScale = chroma.scale('YlOrRd').domain([0, 1]);

            L.geoJSON(data, {
                style: function(feature) {
                    const val = feature.properties.duration_sum;

                    if (val === undefined || val <= 0) {
                        return {
                            fillColor: '#ccc',
                            color: 'black',
                            weight: 0.5,
                            fillOpacity: 0.7
                        };
                    }

                    const logVal = log1p(val);
                    const normalizedVal = normalize(logVal, minLog1p, maxLog1p);
                    const fillColor = colorScale(normalizedVal).hex();

                    return {
                        fillColor: fillColor,
                        color: 'black',
                        weight: 0.5,
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties || {};
                    let centerLat = '', centerLon = '';

                    if (feature.geometry.type === 'Polygon') {
                        const center = getPolygonCenter(feature.geometry.coordinates);
                        centerLat = center[0].toFixed(6);
                        centerLon = center[1].toFixed(6);
                    }

                    let popupContent = `
                        <strong>H3 Index:</strong> ${props.h3_cell || ''}<br>
                        <strong>Duration Sum:</strong> ${props.duration_sum || ''}<br>
                        <strong>Unique Vehicle Count:</strong> ${props.unique_veh_count || ''}<br>
                        <strong>Center Lat, Long:</strong> ${centerLat},${centerLon} <br>
                       
                    `;
                    layer.bindPopup(popupContent);
                }
        }).addTo(h3Layer);

    } catch (error) {
        console.error('Error loading H3 GeoJSON:', error);
    }
}

// Initial load
loadH3GeoJSON('http://localhost:8080/Downloads/h3_cells_9_95_20.geojson');

// Listen for dropdown changes
document.getElementById('h3Selector').addEventListener('change', function() {
    const selectedFile = this.value;
    loadH3GeoJSON(`http://localhost:8080/Downloads/${selectedFile}`);
});
</script>

</body>
</html>
