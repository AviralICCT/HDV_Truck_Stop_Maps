<!DOCTYPE html>
<html lang="en">
<head>
    <title>SCOUT CHARGE-PARK</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Chroma.js for color scales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
<!-- Leaflet Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- Leaflet Routing Machine -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<!-- Leaflet Draw for distance measurement -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@latest/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet-draw@latest/dist/leaflet.draw.js"></script>


    <style>
        :root {
            --primary-color: #3B82F6;
            --text-color: #1F2937;
            --bg-color: #FFFFFF;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            position: relative;
            z-index: 0;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem; /* Increased horizontal padding */
            z-index: 1001;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 3.5rem;
        }

.leaflet-bottom.leaflet-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    padding: 10px;
}

/* Search button + box */
.search-wrapper {
    position: relative;
}

.search-toggle-button {
    width: 30px;
    height: 30px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
}

.search-box {
    background: white;
    padding: 6px;
    width: 240px;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.5);
    margin-top: 6px;
    display: none;
}


  .logo-container {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Modified to space between */
            width: 100%; /* Full width to ensure proper spacing */
            height: 100%;
        }
	
        
        .logo-left {
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        .logo-left img {
            height: auto;
            max-width: 180px;
            width: 100%;
        }
        
        .logo-right {
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        .logo-right img {
            height: auto;
            max-width: 65px;
            width: 100%;
        }
        
        .app-title {
            flex: 1 0 auto; /* Grow but don't shrink */
            text-align: center;
            font-size: clamp(0.8rem, 1.5vw, 1.2rem);
            font-weight: 700;
            color: #2563EB;
            line-height: 1.1;
            margin: 0 1rem; /* Increased margin for better spacing */
        }
        
        .info-panel {
            position: absolute;
            top: 4rem;
            left: 1rem;
            width: clamp(280px, 35vw, 400px);
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            z-index: 1000;
            transition: transform 0.3s ease;
            max-height: calc(100vh - 5rem);
            overflow-y: auto;
        }
        
        .info-panel h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1E40AF;
        }
        
        .info-panel p {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .control-panel {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 1rem;
            width: 100%;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        .legend-color-box {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            vertical-align: middle;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        #h3Selector {
            width: 100%;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #D1D5DB;
            background-color: white;
            font-family: inherit;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        #h3Selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
	
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 0.25rem;
                height: auto; /* Allow header to adjust to content */
            }
	     
            .logo-container {
                justify-content: space-between;
                width: 100%;
            }


            
            .app-title {
                margin: 0.25rem 0;
                font-size: 0.9rem;
            }
            
            .logo-left img, .logo-right img {
                max-width: 100px;
            }
            
            .info-panel {
                top: 3rem;
                left: 0.5rem;
                width: calc(100% - 1rem);
                max-width: none;
            }
            
            .leaflet-control-layers {
                max-width: 90vw;
            }
        }
        
        /* Fix for zoom controls - moved to the right side */
        .leaflet-control-zoom {
            position: absolute;
            right: 10px;
            top: 4.5rem; /* Positioned below header */
            z-index: 1000;
        }
        
        /* Custom controls styling */
        .leaflet-control-layers {
            border: none !important;
            border-radius: var(--border-radius) !important;
            box-shadow: var(--card-shadow) !important;
            display: none !important; /* Hide the default layer control */
        }
        
        .leaflet-control-layers-expanded {
            padding: 1rem !important;
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(5px);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Custom layer toggles */
        .layer-toggles-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .leaflet-control-layers-selector {
            margin-right: 0.5rem;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius);
            padding: 0.5rem;
        }
        
        .leaflet-popup-content {
            margin: 0.5rem 0.75rem;
            line-height: 1.5;
        }
        
        .leaflet-container { 
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
        }
        
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            border: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        /* Custom legend in layers control */
        .custom-legend {
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
            margin-top: 1rem;
        }
        
        .custom-legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .gradient-legend {
            height: 20px;
            width: 100%;
            background: linear-gradient(to right, #ffffb2, #fed976, #feb24c, #fd8d3c, #f03b20, #bd0026);
            border-radius: 3px;
            margin-bottom: 0.5rem;
        }
        
        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
	.autocomplete-container {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5em;
    margin-top: 0.5em;
}

.autocomplete-suggestions {
    background: white;
    border: 1px solid #ccc;
    z-index: 10000;
    max-height: 150px;
    overflow-y: auto;
    width: 100%;
    display: none;
    font-size: 0.9em;
    margin-top: 0.25em;
    position: static;
    /* Add these new rules: */
    min-width: 240px; /* Fixed minimum width */
    max-width: 300px; /* Fixed maximum width */
    box-sizing: border-box;
    white-space: nowrap; /* Prevent text wrapping */
}

.autocomplete-suggestions div {
    padding: 0.5em;
    cursor: pointer;
    /* Add these: */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.autocomplete-suggestions div:hover {
    background: #f0f0f0;
}

.input-row {
    display: flex;
    gap: 5px;
    margin-bottom: 5px;
}

.input-row input {
    flex: 1;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

.input-row button {
    padding: 5px 8px;
    background: #3388ff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    white-space: nowrap;
    font-size: 0.8em;
}

.button-row {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

.button-row button {
    flex: 1;
    padding: 6px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
}

.routing-input-panel {
    background: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    min-width: 280px;
}
.routing-input-panel {
    background: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    min-width: 280px;
    /* Add these new rules: */
    pointer-events: auto;
    z-index: 1000;
}

.routing-input-panel input,
.routing-input-panel button {
    pointer-events: auto;
}
.custom-marker-icon {
    background: transparent !important;
    border: none !important;
}	
    </style>
</head>

<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo-left">
                <img src="https://coezet.iitm.ac.in/wp-content/uploads/2023/01/coezet_34-8.png" alt="CoEZET Logo">
            </div>
            <div class="app-title">
                SCOUT CHARGE-PARK
                <span style="font-size: 0.75em; font-weight: normal; display: block; line-height: 1;">Scouting Tool for Optimal Truck Chargepark Locations</span>
            </div>
            <div class="logo-right">
                <img src="https://s12982.pcdn.co/wp-content/uploads/2019/02/icct-logo.png" alt="ICCT Logo">
            </div>
        </div>
    </div>



 

    <div class="info-panel">
	
        <div id="analysis-control" class="control-panel">
            <h4> Control Panel</h4>

	  


            <div class="selection-container">
                <label for="h3Selector" class="legend-title">Select Scouting Scope:</label>
                <select id="h3Selector">
                    <option value="gdf_truck_frame_with_hex_res5_100_20.geojson">Country Level</option>
                    <option value="gdf_truck_frame_with_hex_res7_100_20.geojson">Region/State Level</option>
                    <option value="gdf_truck_frame_with_hex_res9_100_20.geojson">City Level</option>
                </select>
            </div>
            
            <div class="legend-container">
                <div class="legend-title">Location Utility Heatmap</div>
                <div class="gradient-legend"></div>
                <div class="gradient-labels">
                    <span>Lower utility</span>
                    <span>Higher utility</span>
                </div>
            </div>
            
	    
            <div id="layer-toggles" class="layer-toggles-container">
                <div class="legend-title"><i class="fas fa-layer-group"></i> Layer Visibility</div>
                <div class="layer-toggle">
                    <input type="checkbox" id="h3-toggle" checked>
                    <label for="h3-toggle"><i class="fa-solid fa-truck"></i> Truck Stop Data</label>
                </div>
                
                <!-- Substations section -->
                <div class="layer-section">
                    <div class="layer-section-title">Substations</div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="high-voltage-toggle">
                        <label for="high-voltage-toggle" id="high-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="medium-voltage-toggle">
                        <label for="medium-voltage-toggle" id="medium-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="low-voltage-toggle">
                        <label for="low-voltage-toggle" id="low-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="no-voltage-toggle">
                        <label for="no-voltage-toggle" id="no-voltage-label"></label>
                    </div>
                </div>
                
                <!-- Transmission Lines section -->
                <div class="layer-section">
                    <div class="layer-section-title">Transmission Lines</div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="line-high-voltage-toggle">
                        <label for="line-high-voltage-toggle" id="line-high-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="line-medium-voltage-toggle">
                        <label for="line-medium-voltage-toggle" id="line-medium-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="line-low-voltage-toggle">
                        <label for="line-low-voltage-toggle" id="line-low-voltage-label"></label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="line-no-voltage-toggle">
                        <label for="line-no-voltage-toggle" id="line-no-voltage-label"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div id="map"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <script>
        // Initialize map with improved default view
        const map = L.map('map', {
            zoomControl: false // Disable default zoom control to reposition it
        }).setView([20.59, 78.96], 5);
        
        // Add custom positioned zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // Add a nicer basemap
       const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> 	contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
	const satelliteLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=s&hl=en&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    attribution: 'Imagery Â© Google'
});

        // Create layer groups for substations
        const lowVoltageLayer = L.layerGroup();
        const mediumVoltageLayer = L.layerGroup();
        const highVoltageLayer = L.layerGroup();
        const noVoltageLayer = L.layerGroup();
        
        // Create layer groups for transmission lines
        const lineHighVoltageLayer = L.layerGroup();
        const lineMediumVoltageLayer = L.layerGroup();
        const lineLowVoltageLayer = L.layerGroup();
        const lineNoVoltageLayer = L.layerGroup();
        const h3Layer = L.layerGroup().addTo(map);

        // Helper functions
        function categorizeVoltage(voltage) {
            if (!voltage) return 'noVoltage';

            let voltages = voltage.includes(';') ? voltage.split(';') :
                        voltage.includes(',') ? voltage.split(',') :
                        [voltage];

            let maxVoltage = 0;
            voltages.forEach(v => {
                let num = parseInt(v.replace(/D/g, ''), 10);
                if (!isNaN(num) && num > maxVoltage) maxVoltage = num;
            });

            if (maxVoltage === 0) return 'noVoltage';
            if (maxVoltage < 50000) return 'lowVoltage';
            if (maxVoltage < 132000) return 'mediumVoltage';
            return 'highVoltage';
        }

        const categoryColors = {
            lowVoltage: "#2ca02c",    // green
            mediumVoltage: "#ff7f0e", // orange
            highVoltage: "#d62728",   // red
            noVoltage: "#7f7f7f"      // gray
        };
	
	// Line thickness for transmission lines
        const lineThickness = {
            lowVoltage: 1.5,
            mediumVoltage: 1.5,
            highVoltage: 1.5,
            noVoltage: 1.5
        };


        function makeLabelWithColor(color, label) {
            return `<span style="
                display:inline-block; 
                width:18px; 
                height:18px; 
                background:${color}; 
                margin-right:8px; 
                border-radius:3px; 
                border:1px solid rgba(0,0,0,0.2);
                vertical-align: middle;
            "></span>${label}`;
        }
	
	function makeLineLabel(color, thickness, label) {
            return `<span style="
                display:inline-block; 
                width:20px; 
                height:${thickness}px; 
                background:${color}; 
                margin-right:8px;
                vertical-align: middle;
            "></span>${label}`;
        }

        function getPolygonCenter(coords) {
            let latSum = 0, lngSum = 0, count = 0;
            coords[0].forEach(pt => {
                lngSum += pt[0];
                latSum += pt[1];
                count++;
            });
            return [latSum / count, lngSum / count];
        }

        function log1p(x) {
            return Math.log(1 + x);
        }

        function normalize(value, min, max) {
            return (value - min) / (max - min);
        }

        // Create layer control with better styling
        const layerControl = L.control.layers(
            // Base layers (none defined yet)
            {},
            // Overlays 
            {
                "Location Traffic Load Heatmap": h3Layer
            },
            {collapsed: false}
        ).addTo(map);

	// Set labels for substation toggles
        document.getElementById('high-voltage-label').innerHTML = makeLabelWithColor(categoryColors.highVoltage, "Substation (>132kV)");
        document.getElementById('medium-voltage-label').innerHTML = makeLabelWithColor(categoryColors.mediumVoltage, "Substation (50kV-132kV)");
        document.getElementById('low-voltage-label').innerHTML = makeLabelWithColor(categoryColors.lowVoltage, "Substation (<50kV)");
        document.getElementById('no-voltage-label').innerHTML = makeLabelWithColor(categoryColors.noVoltage, "Substation (No Voltage Data)");
        
        // Set labels for transmission line toggles
        document.getElementById('line-high-voltage-label').innerHTML = makeLineLabel(categoryColors.highVoltage, lineThickness.highVoltage, "Line (>132kV)");
        document.getElementById('line-medium-voltage-label').innerHTML = makeLineLabel(categoryColors.mediumVoltage, lineThickness.mediumVoltage, "Line (50kV-132kV)");
        document.getElementById('line-low-voltage-label').innerHTML = makeLineLabel(categoryColors.lowVoltage, lineThickness.lowVoltage, "Line (<50kV)");
        document.getElementById('line-no-voltage-label').innerHTML = makeLineLabel(categoryColors.noVoltage, lineThickness.noVoltage, "Line (No Voltage Data)");


        // Fetch and process substation data
        fetch('Layer2sub.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function(feature, latlng) {
                        const voltageTag = feature.properties?.voltage;
                        const category = categorizeVoltage(voltageTag);

                        return L.circleMarker(latlng, {
                            radius: 6,
                            color: "#ffffff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.9,
                            fillColor: categoryColors[category]
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const tags = feature.properties || {};
                        let popupContent = "<div style='max-height: 200px; overflow-y: auto;'>";
                        popupContent += "<strong>Substation Details</strong><hr>";
                        
                        // Show key information first
                        if (tags.name) popupContent += `<strong>Name:</strong> ${tags.name}<br>`;
                        if (tags.voltage) popupContent += `<strong>Voltage:</strong> ${tags.voltage}<br>`;
                        if (tags.operator) popupContent += `<strong>Operator:</strong> ${tags.operator}<br>`;
                        
                        // Add coordinates
                        let coords = null;
                        if (feature.geometry.type === "Point") {
                            coords = feature.geometry.coordinates;
                        }
                        if (coords) {
                            popupContent += `<strong>Location:</strong> ${coords[1]?.toFixed(6)}, ${coords[0]?.toFixed(6)}<br>`;
                        }
                        
                        // Add all other tags
                        popupContent += "<hr><strong>All Tags:</strong><ul>";
                        for (const key in tags) {
                            if (!['name', 'voltage', 'operator'].includes(key)) {
                                popupContent += `<li><b>${key}:</b> ${tags[key]}</li>`;
                            }
                        }
                        popupContent += "</ul></div>";

                        layer.bindPopup(popupContent);

                        // Add to appropriate voltage layer
                        const category = categorizeVoltage(tags.voltage);
                        switch (category) {
                            case 'lowVoltage':
                                lowVoltageLayer.addLayer(layer);
                                break;
                            case 'mediumVoltage':
                                mediumVoltageLayer.addLayer(layer);
                                break;
                            case 'highVoltage':
                                highVoltageLayer.addLayer(layer);
                                break;
                            default:
                                noVoltageLayer.addLayer(layer);
                        }
                    }
                });

                // Add all voltage layers to map by default
                // lowVoltageLayer.addTo(map);
                // mediumVoltageLayer.addTo(map);
                // highVoltageLayer.addTo(map);
                // noVoltageLayer.addTo(map);

                // Add substations to layer control
                // Add to default layer control (hidden)
                layerControl.addOverlay(highVoltageLayer, makeLabelWithColor(categoryColors.highVoltage, "Substation (>132kV)"));
                layerControl.addOverlay(mediumVoltageLayer, makeLabelWithColor(categoryColors.mediumVoltage, "Substation (50kV-132kV)"));
                layerControl.addOverlay(lowVoltageLayer, makeLabelWithColor(categoryColors.lowVoltage, "Substation (<50kV)"));
                layerControl.addOverlay(noVoltageLayer, makeLabelWithColor(categoryColors.noVoltage, "Substation (No Voltage Data)"));
                



		fetch('export.geojson.gz')
  .then(response => {
    if (!response.ok) throw new Error("Network response was not ok");
    return response.arrayBuffer();
  })
  .then(buffer => {
    const decompressed = pako.ungzip(new Uint8Array(buffer), { to: 'string' });
    const data = JSON.parse(decompressed);

                L.geoJSON(data, {
                    style: function(feature) {
                        const voltageTag = feature.properties?.voltage;
                        const category = categorizeVoltage(voltageTag);
                        
                        return {
                            color: categoryColors[category],
                            weight: lineThickness[category],
                            opacity: 0.8,
                            lineCap: 'round',
                            lineJoin: 'round'
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const tags = feature.properties || {};
                        let popupContent = "<div style='max-height: 200px; overflow-y: auto;'>";
                        popupContent += "<strong>Transmission Line Details</strong><hr>";
                        
                        // Show key information first
                        if (tags.name) popupContent += `<strong>Name:</strong> ${tags.name}<br>`;
                        if (tags.voltage) popupContent += `<strong>Voltage:</strong> ${tags.voltage}<br>`;
                        if (tags.operator) popupContent += `<strong>Operator:</strong> ${tags.operator}<br>`;
                        if (tags.cables) popupContent += `<strong>Cables:</strong> ${tags.cables}<br>`;
                        if (tags.circuits) popupContent += `<strong>Circuits:</strong> ${tags.circuits}<br>`;
                        
                        // Add all other tags
                        popupContent += "<hr><strong>All Tags:</strong><ul>";
                        for (const key in tags) {
                            if (!['name', 'voltage', 'operator', 'cables', 'circuits'].includes(key)) {
                                popupContent += `<li><b>${key}:</b> ${tags[key]}</li>`;
                            }
                        }
                        popupContent += "</ul></div>";

                        layer.bindPopup(popupContent);

                        // Add to appropriate voltage layer
                        const category = categorizeVoltage(tags.voltage);
                        switch (category) {
                            case 'lowVoltage':
                                lineLowVoltageLayer.addLayer(layer);
                                break;
                            case 'mediumVoltage':
                                lineMediumVoltageLayer.addLayer(layer);
                                break;
                            case 'highVoltage':
                                lineHighVoltageLayer.addLayer(layer);
                                break;
                            default:
                                lineNoVoltageLayer.addLayer(layer);
                        }
                    }
                });
                
                // Add hidden overlays to the layer control
                layerControl.addOverlay(lineHighVoltageLayer, makeLineLabel(categoryColors.highVoltage, lineThickness.highVoltage, "Line (>132kV)"));
                layerControl.addOverlay(lineMediumVoltageLayer, makeLineLabel(categoryColors.mediumVoltage, lineThickness.mediumVoltage, "Line (50kV-132kV)"));
                layerControl.addOverlay(lineLowVoltageLayer, makeLineLabel(categoryColors.lowVoltage, lineThickness.lowVoltage, "Line (<50kV)"));
                layerControl.addOverlay(lineNoVoltageLayer, makeLineLabel(categoryColors.noVoltage, lineThickness.noVoltage, "Line (No Voltage Data)"));
            })
            .catch(err => console.error('Error loading transmission_lines.geojson:', err));

		
		// Load H3 GeoJSON data
            async function loadH3GeoJSON(url) {
            // Clear existing layer
            h3Layer.clearLayers();

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Extract duration_sum values for color scale
                const logValues = data.features
                    .map(f => f.properties.duration_sum)
                    .filter(v => v !== undefined && v > 0)
                    .map(v => log1p(v));

                const minLog1p = Math.min(...logValues);
                const maxLog1p = Math.max(...logValues);

                // Create chroma color scale with YlOrRd palette
                const colorScale = chroma.scale(['#ffffb2', '#fed976', '#feb24c', '#fd8d3c', '#f03b20', '#bd0026']).domain([0, 1]);

                L.geoJSON(data, {
                    style: function(feature) {
                        const val = feature.properties.duration_sum;

                        if (val === undefined || val <= 0) {
                            return {
                                fillColor: '#ccc',
                                color: '#999',
                                weight: 0.5,
                                fillOpacity: 0.7
                            };
                        }

                        const logVal = log1p(val);
                        const normalizedVal = normalize(logVal, minLog1p, maxLog1p);
                        const fillColor = colorScale(normalizedVal).hex();

                        return {
                            fillColor: fillColor,
                            color: '#444',
                            weight: 0.5,
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties || {};
                        let centerCoords = [];

                        if (feature.geometry.type === 'Polygon') {
                            centerCoords = getPolygonCenter(feature.geometry.coordinates);
                        }

                        // Format the h3 cell data for display, showing actual values or appropriate placeholders
                        const h3Index = props.h3_cell || props.h3_parent || 'Not available';
                        const durationSum = props.duration_sum !== undefined ? props.duration_sum : 'Not available';
                        const uniqueVehicles = props.unique_veh_count !== undefined ? props.unique_veh_count : 'Not available';
                        
                        // Only show coordinates if we successfully calculated them
                        const coordsDisplay = centerCoords.length === 2 ? 
                            `${centerCoords[0].toFixed(6)}, ${centerCoords[1].toFixed(6)}` : 
                            'Not available';

                        let popupContent = `
                            <div class="h3-popup">
                                <strong>H3 Cell Details</strong><hr>
                                <table style="width:100%; border-collapse: collapse;">
                                    <tr>
                                        <td><strong>H3 Index:</strong></td>
                                        <td>${h3Index}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Duration Sum:</strong></td>
                                        <td>${durationSum}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Unique Vehicles:</strong></td>
                                        <td>${uniqueVehicles}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Center:</strong></td>
                                        <td>${coordsDisplay}</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(h3Layer);

            } catch (error) {
                console.error('Error loading H3 GeoJSON:', error);
            }
        }

		// Load initial H3 data
        loadH3GeoJSON('gdf_truck_frame_with_hex_res5_100_20.geojson');
                
                // Add event listeners for custom toggles
                document.getElementById('h3-toggle').addEventListener('change', function(e) {
                    if (e.target.checked) {
                        map.addLayer(h3Layer);
                    } else {
                        map.removeLayer(h3Layer);
                    }
                });
                
                document.getElementById('high-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(highVoltageLayer);
                    } else {
                        map.removeLayer(highVoltageLayer);
                    }
                });
                
                document.getElementById('medium-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(mediumVoltageLayer);
                    } else {
                        map.removeLayer(mediumVoltageLayer);
                    }
                });
                
                document.getElementById('low-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(lowVoltageLayer);
                    } else {
                        map.removeLayer(lowVoltageLayer);
                    }
                });
                
                document.getElementById('no-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(noVoltageLayer);
                    } else {
                        map.removeLayer(noVoltageLayer);
                    }
                });
		
		document.getElementById('medium-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(mediumVoltageLayer);
            } else {
                map.removeLayer(mediumVoltageLayer);
            }
        });
        
        document.getElementById('low-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(lowVoltageLayer);
            } else {
                map.removeLayer(lowVoltageLayer);
            }
        });
        
        document.getElementById('no-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(noVoltageLayer);
            } else {
                map.removeLayer(noVoltageLayer);
            }
        });
        
        // Event listeners for transmission line toggles
        document.getElementById('line-high-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(lineHighVoltageLayer);
            } else {
                map.removeLayer(lineHighVoltageLayer);
            }
        });
        
        document.getElementById('line-medium-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(lineMediumVoltageLayer);
            } else {
                map.removeLayer(lineMediumVoltageLayer);
            }
        });
        
        document.getElementById('line-low-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(lineLowVoltageLayer);
            } else {
                map.removeLayer(lineLowVoltageLayer);
            }
        });
        
        document.getElementById('line-no-voltage-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(lineNoVoltageLayer);
            } else {
                map.removeLayer(lineNoVoltageLayer);
            }
        });
        
        // Event listener for H3 resolution selector
        document.getElementById('h3Selector').addEventListener('change', function(e) {
            loadH3GeoJSON(e.target.value);
        });
            })
            .catch(err => console.error('Error loading Substations.geojson:', err));

        
        
        // Add a scale control to the map
        L.control.scale({
            imperial: false,
            position: 'bottomright'
        }).addTo(map);
        
        // Add a custom info button to toggle info panel
        const infoPanel = document.querySelector('.info-panel');
        const infoPanelControl = L.Control.extend({
            options: {
                position: 'bottomleft'
            },
            
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'info-button', container);
                button.href = '#';
                button.title = 'Toggle Info Panel';
                button.innerHTML = '<i class="fas fa-info"></i>';
                button.style.fontWeight = 'bold';
                button.style.fontSize = '16px';
                button.style.display = 'flex';
                button.style.alignItems = 'center';
                button.style.justifyContent = 'center';
                button.style.width = '30px';
                button.style.height = '30px';
                
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    L.DomEvent.preventDefault(e);
                    infoPanel.style.display = infoPanel.style.display === 'none' ? 'block' : 'none';
                });
                
                return container;
            }
        });
        
        map.addControl(new infoPanelControl());
        
        // Function to add hover effect to H3 cells
        function addHoverInteraction() {
            const h3Features = document.querySelectorAll('.leaflet-interactive');
            h3Features.forEach(feature => {
                feature.addEventListener('mouseover', function() {
                    this.style.fillOpacity = '0.9';
                    this.style.cursor = 'pointer';
                });
                
                feature.addEventListener('mouseout', function() {
                    this.style.fillOpacity = '0.7';
                });
            });
        }
        
        // Call addHoverInteraction after a delay to ensure the DOM elements are loaded
        setTimeout(addHoverInteraction, 1000);
        

        // Function to update the map when window is resized
        function handleResize() {
            // Calculate new dimensions for the map
            const mapContainer = document.getElementById('map');
            mapContainer.style.height = window.innerHeight + 'px';
            
            // Update internal map dimensions
            map.invalidateSize();
        }
        
        // Add resize listener
        window.addEventListener('resize', handleResize);
        
        // Handle initial size
        handleResize();

// --- 1. Custom Search Control ---
const searchControl = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function () {
        const container = L.DomUtil.create('div', 'search-container');
	
        container.innerHTML = `<div id="geocoder-container"></div>`;
        return container;
    }
});
map.addControl(new searchControl());

const geocoder = L.Control.geocoder({
    defaultMarkGeocode: false,
    placeholder: 'Search for a location...',
    errorMessage: 'Nothing found.',
    showResultIcons: true
}).on('markgeocode', function(e) {
    const latlng = e.geocode.center;
    map.setView(latlng, 13);
});

// Add geocoder into the created container
setTimeout(() => {
    const target = document.getElementById('geocoder-container');
    if (target) target.appendChild(geocoder.onAdd(map));
}, 100);


// --- 2. Routing Button Control ---

let originMarker = null;
let destinationMarker = null;

// Custom marker icons
const originIcon = L.divIcon({
    html: '<i class="fas fa-map-marker-alt" style="color: green; font-size: 24px;"></i>',
    iconSize: [24, 24],
    iconAnchor: [12, 24],
    popupAnchor: [0, -24],
    className: 'custom-marker-icon'
});

const destinationIcon = L.divIcon({
    html: '<i class="fas fa-map-marker-alt" style="color: red; font-size: 24px;"></i>',
    iconSize: [24, 24],
    iconAnchor: [12, 24],
    popupAnchor: [0, -24],
    className: 'custom-marker-icon'
});



function addOriginMarker(latlng, address = '') {
    if (originMarker) {
        map.removeLayer(originMarker);
    }
    originMarker = L.marker(latlng, { icon: originIcon })
        .addTo(map)
        .bindPopup(`<strong>Origin</strong><br>${address || `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`}`);
}

function addDestinationMarker(latlng, address = '') {
    if (destinationMarker) {
        map.removeLayer(destinationMarker);
    }
    destinationMarker = L.marker(latlng, { icon: destinationIcon })
        .addTo(map)
        .bindPopup(`<strong>Destination</strong><br>${address || `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`}`);
}

function clearMarkers() {
    if (originMarker) {
        map.removeLayer(originMarker);
        originMarker = null;
    }
    if (destinationMarker) {
        map.removeLayer(destinationMarker);
        destinationMarker = null;
    }
}


const routingControl = L.Routing.control({
    waypoints: [],
    routeWhileDragging: true,
    lineOptions: { styles: [{ color: '#00FFFF', weight: 5 }] },
    createMarker: function() { return null; },
    router: L.Routing.osrmv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: 'driving'
    }),
    collapsible: true,
    show: false
});

const routingButton = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', 'routing-button', container);
        button.href = '#';
        button.title = 'Find Route';
        button.innerHTML = '<i class="fas fa-route"></i>';
        button.style.cssText = 'font-weight:bold;font-size:16px;display:flex;align-items:center;justify-content:center;width:30px;height:30px';

        let routingActive = false;
        L.DomEvent.on(button, 'click', function (e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            if (!routingActive) {
                routingControl.addTo(map);
                button.style.backgroundColor = '#3388ff';
                button.style.color = 'white';
                routingActive = true;
            } else {
                routingControl.remove();
                button.style.backgroundColor = '';
                button.style.color = '';
                routingActive = false;
            }
        });

        return container;
    }
});



map.addControl(new routingButton());

const routingInputPanel = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function () {
        const container = L.DomUtil.create('div', 'routing-input-panel leaflet-bar');
        container.innerHTML = `
    <div class="autocomplete-container">
        <div class="input-row">
            <input type="text" id="startLocation" placeholder="Enter origin" autocomplete="off" />
	    <t>OR</t>
            <button id="selectStartBtn">Select on Map</button>
        </div>
        <div class="autocomplete-suggestions" id="startSuggestions"></div>
        
        <div class="input-row">
            <input type="text" id="endLocation" placeholder="Enter destination" autocomplete="off" />
	    <t>OR</t>
            <button id="selectEndBtn">Select on Map</button>
        </div>
        <div class="autocomplete-suggestions" id="endSuggestions"></div>
        
        <div class="button-row">
            <button id="routeByTextBtn">Find Route</button>
            <button id="clearRouteBtn">Clear Route</button>
            <button id="reverseRouteBtn">Reverse Route</button>
        </div>
    </div>
`;
        container.style.display = 'none';
        return container;
    }
});

const inputPanel = new routingInputPanel();
map.addControl(inputPanel);

const routingPanelElement = document.querySelector('.routing-input-panel');
routingPanelElement.addEventListener('mouseenter', function() {
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.scrollWheelZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
});

routingPanelElement.addEventListener('mouseleave', function() {
    map.dragging.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.scrollWheelZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
});

// Prevent click events from propagating to the map

routingPanelElement.addEventListener('click', function(e) {
    L.DomEvent.stopPropagation(e);
});

let routingButtonToggled = false;
const originalRoutingButton = document.querySelector('.routing-button');
originalRoutingButton.addEventListener('click', function () {
    routingButtonToggled = !routingButtonToggled;
    document.querySelector('.routing-input-panel').style.display = routingButtonToggled ? 'block' : 'none';
});

function setupAutocomplete(inputId, suggestionBoxId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionBoxId);

    input.addEventListener('input', function () {
        const query = input.value.trim();
        if (query.length < 3) {
	    suggestions.innerHTML = '';
            suggestions.style.display = 'none';
            return;
        }

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`)
            .then(res => res.json())
            .then(data => {
                suggestions.innerHTML = '';
                if (data.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }

                data.forEach(result => {
                    const item = document.createElement('div');
                    item.textContent = result.display_name;
                    item.addEventListener('click', function () {
                        input.value = result.display_name;
                        suggestions.style.display = 'none';
			const latlng = L.latLng(result.lat, result.lon);
    if (inputId === 'startLocation') {
        addOriginMarker(latlng, result.display_name);
    } else if (inputId === 'endLocation') {
        addDestinationMarker(latlng, result.display_name);
    }
                    });
                    suggestions.appendChild(item);
                });
                suggestions.style.display = 'block';
            });
    });

    input.addEventListener('blur', () => {
        setTimeout(() => suggestions.style.display = 'none', 150);
    });
suggestions.addEventListener('wheel', function(e) {
    e.stopPropagation();
});

suggestions.addEventListener('mouseenter', function() {
    map.scrollWheelZoom.disable();
});

suggestions.addEventListener('mouseleave', function() {
    map.scrollWheelZoom.enable();
});

    input.addEventListener('focus', () => {
        if (suggestions.children.length > 0) {
            suggestions.style.display = 'block';
        }
    });
}

function bindRoutingEvents() {
	
    let selectingStart = false;
    let selectingEnd = false;
    document.getElementById('routeByTextBtn').addEventListener('click', function () {
        const startText = document.getElementById('startLocation').value;
        const endText = document.getElementById('endLocation').value;

        if (!startText || !endText) {
            alert('Please enter both origin and destination.');
            return;
        }

        Promise.all([
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(startText)}`).then(res => res.json()),
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endText)}`).then(res => res.json())
        ]).then(([startResults, endResults]) => {
            if (!startResults.length || !endResults.length) {
                alert('Could not find one or both locations.');
                return;
            }

            const startCoords = L.latLng(startResults[0].lat, startResults[0].lon);
            const endCoords = L.latLng(endResults[0].lat, endResults[0].lon);
	
            addOriginMarker(startCoords, startResults[0].display_name);
            addDestinationMarker(endCoords, endResults[0].display_name);

            routingControl.setWaypoints([startCoords, endCoords]);
            map.fitBounds(L.latLngBounds(startCoords, endCoords));
        }).catch(err => {
            console.error('Geocoding error:', err);
            alert('Failed to get route due to network or service error.');
        });
    });

    document.getElementById('clearRouteBtn').addEventListener('click', function () {
        routingControl.setWaypoints([]);
        document.getElementById('startLocation').value = '';
        document.getElementById('endLocation').value = '';
	clearMarkers();
    });

    document.getElementById('reverseRouteBtn').addEventListener('click', function () {
        const startInput = document.getElementById('startLocation');
        const endInput = document.getElementById('endLocation');

        const temp = startInput.value;
        startInput.value = endInput.value;
        endInput.value = temp;

        if (startInput.value && endInput.value) {
            document.getElementById('routeByTextBtn').click();
        }
    });
document.getElementById('selectStartBtn').addEventListener('click', function (e) {
    
    L.DomEvent.stopPropagation(e);
    L.DomEvent.preventDefault(e);
    selectingStart = true;
    selectingEnd = false;
    alert('Click on the map to select origin');
    
    map.once('click', function (e) {
        if (selectingStart) {
            document.getElementById('startLocation').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            addOriginMarker(e.latlng);
	    selectingStart = false;
        }
    });
});

document.getElementById('selectEndBtn').addEventListener('click', function (e) {
    L.DomEvent.stopPropagation(e);
    L.DomEvent.preventDefault(e);
    selectingEnd = true;
    selectingStart = false;
    alert('Click on the map to select destination');
    
    map.once('click', function (e) {
        if (selectingEnd) {
            document.getElementById('endLocation').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            addDestinationMarker(e.latlng);
	    selectingEnd = false;
        }
    });
});
    setupAutocomplete('startLocation', 'startSuggestions');
    setupAutocomplete('endLocation', 'endSuggestions');
}

// Wait until input panel is rendered
setTimeout(bindRoutingEvents, 500);
   



// --- 3. Measure / Draw Tools ---
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const measureTools = new L.Control.Draw({
    draw: {
        polyline: {
            shapeOptions: {
                color: '#3388ff',
                weight: 4
            },
            metric: true,
            feet: false,
            showLength: true
        },
        polygon: false,
        circle: false,
        rectangle: false,
        marker: false,
        circlemarker: false
    },
    edit: {
        featureGroup: drawnItems,
        edit: false,
        remove: true
    },
    position: 'bottomright'
});
map.addControl(measureTools);

map.on('draw:created', function (e) {
    const layer = e.layer;
    if (e.layerType === 'polyline') {
        const latlngs = layer.getLatLngs();
        let totalDistance = 0;
        for (let i = 1; i < latlngs.length; i++) {
            totalDistance += latlngs[i - 1].distanceTo(latlngs[i]);
        }
        const distanceKm = (totalDistance / 1000).toFixed(2);
        layer.bindPopup(`Distance: ${distanceKm} km`).openPopup();
    }
    drawnItems.addLayer(layer);
});

map.on('draw:deleted', function (e) {
    e.layers.eachLayer(layer => drawnItems.removeLayer(layer));
});


// Event handler for when items are deleted
map.on('draw:deleted', function(e) {
    const layers = e.layers;
    layers.eachLayer(function(layer) {
        drawnItems.removeLayer(layer);
    });
});
onst basemapToggle = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function () {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', '', container);
        button.href = '#';
        button.title = 'Switch Basemap';
        button.innerHTML = '<i class="fas fa-map"></i>';
        button.style.cssText = 'font-size:16px;display:flex;align-items:center;justify-content:center;width:30px;height:30px';

        let usingSatellite = false;

        L.DomEvent.on(button, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            if (usingSatellite) {
                map.removeLayer(satelliteLayer);
                cartoLayer.addTo(map);
            } else {
                map.removeLayer(cartoLayer);
                satelliteLayer.addTo(map);
            }
            usingSatellite = !usingSatellite;
        });

        return container;
    }
});
map.addControl(new basemapToggle());
 </script>
</body>
</html>
