<!DOCTYPE html>
<html lang="en">
<head>
    <title>SCOUT CHARGE-PARK</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <!-- Chroma.js for color scales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3B82F6;
            --text-color: #1F2937;
            --bg-color: #FFFFFF;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-color);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            position: relative;
            z-index: 0;
        }
        
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem; /* Increased horizontal padding */
            z-index: 1001;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: 3.5rem;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Modified to space between */
            width: 100%; /* Full width to ensure proper spacing */
            height: 100%;
        }
        
        .logo-left {
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        .logo-left img {
            height: auto;
            max-width: 180px;
            width: 100%;
        }
        
        .logo-right {
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        .logo-right img {
            height: auto;
            max-width: 65px;
            width: 100%;
        }
        
        .app-title {
            flex: 1 0 auto; /* Grow but don't shrink */
            text-align: center;
            font-size: clamp(0.8rem, 1.5vw, 1.2rem);
            font-weight: 700;
            color: #2563EB;
            line-height: 1.1;
            margin: 0 1rem; /* Increased margin for better spacing */
        }
        
        .info-panel {
            position: absolute;
            top: 4rem;
            left: 1rem;
            width: clamp(280px, 35vw, 400px);
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--text-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            z-index: 1000;
            transition: transform 0.3s ease;
            max-height: calc(100vh - 5rem);
            overflow-y: auto;
        }
        
        .info-panel h4 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1E40AF;
        }
        
        .info-panel p {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .control-panel {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 1rem;
            width: 100%;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        .legend-color-box {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            vertical-align: middle;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        #h3Selector {
            width: 100%;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #D1D5DB;
            background-color: white;
            font-family: inherit;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        
        #h3Selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 0.25rem;
                height: auto; /* Allow header to adjust to content */
            }
            
            .logo-container {
                justify-content: space-between;
                width: 100%;
            }
            
            .app-title {
                margin: 0.25rem 0;
                font-size: 0.9rem;
            }
            
            .logo-left img, .logo-right img {
                max-width: 100px;
            }
            
            .info-panel {
                top: 3rem;
                left: 0.5rem;
                width: calc(100% - 1rem);
                max-width: none;
            }
            
            .leaflet-control-layers {
                max-width: 90vw;
            }
        }
        
        /* Fix for zoom controls - moved to the right side */
        .leaflet-control-zoom {
            position: absolute;
            right: 10px;
            top: 4.5rem; /* Positioned below header */
            z-index: 1000;
        }
        
        /* Custom controls styling */
        .leaflet-control-layers {
            border: none !important;
            border-radius: var(--border-radius) !important;
            box-shadow: var(--card-shadow) !important;
            display: none !important; /* Hide the default layer control */
        }
        
        .leaflet-control-layers-expanded {
            padding: 1rem !important;
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(5px);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Custom layer toggles */
        .layer-toggles-container {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .leaflet-control-layers-selector {
            margin-right: 0.5rem;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius);
            padding: 0.5rem;
        }
        
        .leaflet-popup-content {
            margin: 0.5rem 0.75rem;
            line-height: 1.5;
        }
        
        .leaflet-container { 
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9rem;
        }
        
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            border: none !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
        }
        
        /* Custom legend in layers control */
        .custom-legend {
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
            margin-top: 1rem;
        }
        
        .custom-legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .gradient-legend {
            height: 20px;
            width: 100%;
            background: linear-gradient(to right, #ffffb2, #fed976, #feb24c, #fd8d3c, #f03b20, #bd0026);
            border-radius: 3px;
            margin-bottom: 0.5rem;
        }
        
        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo-container">
            <div class="logo-left">
                <img src="https://coezet.iitm.ac.in/wp-content/uploads/2023/01/coezet_34-8.png" alt="CoEZET Logo">
            </div>
            <div class="app-title">
                SCOUT CHARGE-PARK
                <span style="font-size: 0.75em; font-weight: normal; display: block; line-height: 1;">Scouting Tool for Optimal Truck Chargepark Locations</span>
            </div>
            <div class="logo-right">
                <img src="https://s12982.pcdn.co/wp-content/uploads/2019/02/icct-logo.png" alt="ICCT Logo">
            </div>
        </div>
    </div>

    <div class="info-panel">
        <div id="analysis-control" class="control-panel">
            <h4><i class="fas fa-layer-group"></i> Analysis Controls</h4>
            <div class="selection-container">
                <label for="h3Selector" class="legend-title">Select Analysis Scope:</label>
                <select id="h3Selector">
                    <option value="h3_cells_5_100_50.geojson">Country Level</option>
                    <option value="h3_cells_7_100_50.geojson">Region/State Level</option>
                    <option value="h3_cells_9_95_20.geojson">City Level</option>
                </select>
            </div>
            
            <div class="legend-container">
                <div class="legend-title">Utility Heatmap</div>
                <div class="gradient-legend"></div>
                <div class="gradient-labels">
                    <span>Lower utility</span>
                    <span>Higher utility</span>
                </div>
            </div>
            
            <div id="layer-toggles" class="layer-toggles-container">
                <!-- Layer toggles will be programmatically placed here -->
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Initialize map with improved default view
        const map = L.map('map', {
            zoomControl: false // Disable default zoom control to reposition it
        }).setView([20.59, 78.96], 5);
        
        // Add custom positioned zoom control
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // Add a nicer basemap
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Create layer groups
        const lowVoltageLayer = L.layerGroup();
        const mediumVoltageLayer = L.layerGroup();
        const highVoltageLayer = L.layerGroup();
        const noVoltageLayer = L.layerGroup();
        const h3Layer = L.layerGroup().addTo(map);

        // Helper functions
        function categorizeVoltage(voltage) {
            if (!voltage) return 'noVoltage';

            let voltages = voltage.includes(';') ? voltage.split(';') :
                        voltage.includes(',') ? voltage.split(',') :
                        [voltage];

            let maxVoltage = 0;
            voltages.forEach(v => {
                let num = parseInt(v.replace(/D/g, ''), 10);
                if (!isNaN(num) && num > maxVoltage) maxVoltage = num;
            });

            if (maxVoltage === 0) return 'noVoltage';
            if (maxVoltage < 50000) return 'lowVoltage';
            if (maxVoltage < 132000) return 'mediumVoltage';
            return 'highVoltage';
        }

        const categoryColors = {
            lowVoltage: "#2ca02c",    // green
            mediumVoltage: "#ff7f0e", // orange
            highVoltage: "#d62728",   // red
            noVoltage: "#7f7f7f"      // gray
        };

        function makeLabelWithColor(color, label) {
            return `<span style="
                display:inline-block; 
                width:18px; 
                height:18px; 
                background:${color}; 
                margin-right:8px; 
                border-radius:3px; 
                border:1px solid rgba(0,0,0,0.2);
                vertical-align: middle;
            "></span>${label}`;
        }

        function getPolygonCenter(coords) {
            let latSum = 0, lngSum = 0, count = 0;
            coords[0].forEach(pt => {
                lngSum += pt[0];
                latSum += pt[1];
                count++;
            });
            return [latSum / count, lngSum / count];
        }

        function log1p(x) {
            return Math.log(1 + x);
        }

        function normalize(value, min, max) {
            return (value - min) / (max - min);
        }

        // Create layer control with better styling
        const layerControl = L.control.layers(
            // Base layers (none defined yet)
            {},
            // Overlays 
            {
                "H3 Utility Analysis": h3Layer
            },
            {collapsed: false}
        ).addTo(map);

        // Fetch and process substation data
        fetch('Layer2sub.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function(feature, latlng) {
                        const voltageTag = feature.properties?.voltage;
                        const category = categorizeVoltage(voltageTag);

                        return L.circleMarker(latlng, {
                            radius: 6,
                            color: "#ffffff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.9,
                            fillColor: categoryColors[category]
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const tags = feature.properties || {};
                        let popupContent = "<div style='max-height: 200px; overflow-y: auto;'>";
                        popupContent += "<strong>Substation Details</strong><hr>";
                        
                        // Show key information first
                        if (tags.name) popupContent += `<strong>Name:</strong> ${tags.name}<br>`;
                        if (tags.voltage) popupContent += `<strong>Voltage:</strong> ${tags.voltage}<br>`;
                        if (tags.operator) popupContent += `<strong>Operator:</strong> ${tags.operator}<br>`;
                        
                        // Add coordinates
                        let coords = null;
                        if (feature.geometry.type === "Point") {
                            coords = feature.geometry.coordinates;
                        }
                        if (coords) {
                            popupContent += `<strong>Location:</strong> ${coords[1]?.toFixed(6)}, ${coords[0]?.toFixed(6)}<br>`;
                        }
                        
                        // Add all other tags
                        popupContent += "<hr><strong>All Tags:</strong><ul>";
                        for (const key in tags) {
                            if (!['name', 'voltage', 'operator'].includes(key)) {
                                popupContent += `<li><b>${key}:</b> ${tags[key]}</li>`;
                            }
                        }
                        popupContent += "</ul></div>";

                        layer.bindPopup(popupContent);

                        // Add to appropriate voltage layer
                        const category = categorizeVoltage(tags.voltage);
                        switch (category) {
                            case 'lowVoltage':
                                lowVoltageLayer.addLayer(layer);
                                break;
                            case 'mediumVoltage':
                                mediumVoltageLayer.addLayer(layer);
                                break;
                            case 'highVoltage':
                                highVoltageLayer.addLayer(layer);
                                break;
                            default:
                                noVoltageLayer.addLayer(layer);
                        }
                    }
                });

                // Add all voltage layers to map by default
                lowVoltageLayer.addTo(map);
                mediumVoltageLayer.addTo(map);
                highVoltageLayer.addTo(map);
                noVoltageLayer.addTo(map);

                // Add substations to layer control
                // Add to default layer control (hidden)
                layerControl.addOverlay(highVoltageLayer, makeLabelWithColor(categoryColors.highVoltage, "Substation (>132kV)"));
                layerControl.addOverlay(mediumVoltageLayer, makeLabelWithColor(categoryColors.mediumVoltage, "Substation (50kV-132kV)"));
                layerControl.addOverlay(lowVoltageLayer, makeLabelWithColor(categoryColors.lowVoltage, "Substation (<50kV)"));
                layerControl.addOverlay(noVoltageLayer, makeLabelWithColor(categoryColors.noVoltage, "Substation (No Voltage Data)"));
                
                // Create custom layer toggle controls
                const layerTogglesContainer = document.getElementById('layer-toggles');
                layerTogglesContainer.innerHTML = `
                    <div class="legend-title">Layer Visibility</div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="h3-toggle" checked>
                        <label for="h3-toggle">H3 Utility Analysis</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="high-voltage-toggle" checked>
                        <label for="high-voltage-toggle">${makeLabelWithColor(categoryColors.highVoltage, "Substation (>132kV)")}</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="medium-voltage-toggle" checked>
                        <label for="medium-voltage-toggle">${makeLabelWithColor(categoryColors.mediumVoltage, "Substation (50kV-132kV)")}</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="low-voltage-toggle" checked>
                        <label for="low-voltage-toggle">${makeLabelWithColor(categoryColors.lowVoltage, "Substation (<50kV)")}</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="no-voltage-toggle" checked>
                        <label for="no-voltage-toggle">${makeLabelWithColor(categoryColors.noVoltage, "Substation (No Voltage Data)")}</label>
                    </div>
                `;
                
                // Add event listeners for custom toggles
                document.getElementById('h3-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(h3Layer);
                    } else {
                        map.removeLayer(h3Layer);
                    }
                });
                
                document.getElementById('high-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(highVoltageLayer);
                    } else {
                        map.removeLayer(highVoltageLayer);
                    }
                });
                
                document.getElementById('medium-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(mediumVoltageLayer);
                    } else {
                        map.removeLayer(mediumVoltageLayer);
                    }
                });
                
                document.getElementById('low-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(lowVoltageLayer);
                    } else {
                        map.removeLayer(lowVoltageLayer);
                    }
                });
                
                document.getElementById('no-voltage-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        map.addLayer(noVoltageLayer);
                    } else {
                        map.removeLayer(noVoltageLayer);
                    }
                });
            })
            .catch(err => console.error('Error loading Substations.geojson:', err));

        // Load H3 GeoJSON data
        async function loadH3GeoJSON(url) {
            // Clear existing layer
            h3Layer.clearLayers();

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Extract duration_sum values for color scale
                const logValues = data.features
                    .map(f => f.properties.duration_sum)
                    .filter(v => v !== undefined && v > 0)
                    .map(v => log1p(v));

                const minLog1p = Math.min(...logValues);
                const maxLog1p = Math.max(...logValues);

                // Create chroma color scale with YlOrRd palette
                const colorScale = chroma.scale(['#ffffb2', '#fed976', '#feb24c', '#fd8d3c', '#f03b20', '#bd0026']).domain([0, 1]);

                L.geoJSON(data, {
                    style: function(feature) {
                        const val = feature.properties.duration_sum;

                        if (val === undefined || val <= 0) {
                            return {
                                fillColor: '#ccc',
                                color: '#999',
                                weight: 0.5,
                                fillOpacity: 0.7
                            };
                        }

                        const logVal = log1p(val);
                        const normalizedVal = normalize(logVal, minLog1p, maxLog1p);
                        const fillColor = colorScale(normalizedVal).hex();

                        return {
                            fillColor: fillColor,
                            color: '#444',
                            weight: 0.5,
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties || {};
                        let centerCoords = [];

                        if (feature.geometry.type === 'Polygon') {
                            centerCoords = getPolygonCenter(feature.geometry.coordinates);
                        }

                        // Format the h3 cell data for display, showing actual values or appropriate placeholders
                        const h3Index = props.h3_cell || props.h3_parent || 'Not available';
                        const durationSum = props.duration_sum !== undefined ? props.duration_sum : 'Not available';
                        const uniqueVehicles = props.unique_veh_count !== undefined ? props.unique_veh_count : 'Not available';
                        
                        // Only show coordinates if we successfully calculated them
                        const coordsDisplay = centerCoords.length === 2 ? 
                            `${centerCoords[0].toFixed(6)}, ${centerCoords[1].toFixed(6)}` : 
                            'Not available';

                        let popupContent = `
                            <div class="h3-popup">
                                <strong>H3 Cell Details</strong><hr>
                                <table style="width:100%; border-collapse: collapse;">
                                    <tr>
                                        <td><strong>H3 Index:</strong></td>
                                        <td>${h3Index}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Duration Sum:</strong></td>
                                        <td>${durationSum}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Unique Vehicles:</strong></td>
                                        <td>${uniqueVehicles}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Center:</strong></td>
                                        <td>${coordsDisplay}</td>
                                    </tr>
                                </table>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(h3Layer);

            } catch (error) {
                console.error('Error loading H3 GeoJSON:', error);
            }
        }

        // Load initial H3 data
        loadH3GeoJSON('h3_cells_5_100_50.geojson');

        // Add event listener for H3 resolution dropdown
        document.getElementById('h3Selector').addEventListener('change', function() {
            const selectedFile = this.value;
            loadH3GeoJSON(`${selectedFile}`);
        });
        
        // Add fade in animation for UI elements
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.header');
            const infoPanel = document.querySelector('.info-panel');
            
            header.style.opacity = '0';
            infoPanel.style.opacity = '0';
            
            setTimeout(() => {
                header.style.transition = 'opacity 0.5s ease';
                header.style.opacity = '1';
            }, 100);
            
            setTimeout(() => {
                infoPanel.style.transition = 'opacity 0.5s ease';
                infoPanel.style.opacity = '1';
            }, 300);
        });
    </script>
</body>
</html>
